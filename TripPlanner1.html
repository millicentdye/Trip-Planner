<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trip Planner ‚Äî Options + Itinerary</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#14151a;
      --muted:#5a6072;
      --line:rgba(20,21,26,.10);
      --shadow: 0 10px 28px rgba(20,21,26,.10);
      --radius:16px;
      --radius2:22px;
      --accent:#6d5cff;
      --accent2:#00c2ff;
      --good:#20c997;
      --warn:#f6b73c;
      --bad:#ff4d6d;
      --chip:#f2f4ff;
      --chipText:#2c2f64;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 10% -10%, rgba(109,92,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 95% 0%, rgba(0,194,255,.16), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding: 22px 18px 8px;
      max-width: 1200px;
      margin: 0 auto;
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .title{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(109,92,255,.22);
    }
    h1{ margin:0; font-size: 20px; letter-spacing:-.2px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size: 13px; line-height:1.35; }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button{
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(20,21,26,.06);
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(20,21,26,.10);
      border-color: rgba(20,21,26,.18);
    }
    button.primary{
      background: linear-gradient(135deg, rgba(109,92,255,.98), rgba(0,194,255,.92));
      color:white;
      border-color: rgba(255,255,255,.22);
    }
    button.danger{ color: var(--bad); }
    button.good{ color: var(--good); }
    button.small{ padding: 7px 10px; font-size: 12px; box-shadow:none; }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 34px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
    }
    @media (max-width: 1040px){
      main{ grid-template-columns: 1fr; }
    }
    .panel{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .panel h2{ margin: 0 0 10px; font-size: 14px; letter-spacing:.2px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      border: 1px solid rgba(20,21,26,.14);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      background: white;
      outline:none;
    }
    textarea{ min-height: 70px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(109,92,255,.55);
      box-shadow: 0 0 0 3px rgba(109,92,255,.16);
    }
    .help{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height:1.4;
    }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .tab{
      border:1px solid var(--line);
      background: rgba(246,247,251,.9);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(109,92,255,.14), rgba(0,194,255,.10));
      border-color: rgba(109,92,255,.22);
      color: var(--chipText);
      font-weight: 800;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.85);
      box-shadow: 0 8px 22px rgba(20,21,26,.06);
      padding: 14px;
      margin-bottom: 12px;
    }
    .destHeader{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .destTitle{ font-weight: 900; letter-spacing:-.2px; }
    .destMeta{
      font-size: 12px;
      color: var(--muted);
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 4px;
    }
    .badge{
      font-size: 11px;
      border: 1px solid rgba(20,21,26,.12);
      border-radius: 999px;
      padding: 5px 9px;
      background: white;
      color: var(--muted);
    }
    .destActions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .hidden{ display:none !important; }

    .sectionTitle{
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .opt{
      border: 1px solid rgba(20,21,26,.12);
      border-radius: 16px;
      padding: 10px 10px;
      background: white;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:start;
    }
    .optTop{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .name{ font-weight: 900; letter-spacing:-.15px; }
    .mini{ font-size: 12px; color: var(--muted); margin-top:4px; display:flex; gap:10px; flex-wrap:wrap; }
    .notes{ font-size: 12px; color: var(--muted); margin-top: 6px; white-space: pre-wrap; }
    .link{ font-size: 12px; color: var(--accent); text-decoration:none; word-break:break-all; }
    .link:hover{ text-decoration:underline; }
    .pillSel{
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 8px;
      border: 1px solid rgba(32,201,151,.30);
      background: rgba(32,201,151,.10);
      color: #0c6b50;
      font-weight: 800;
    }
    .pillAlt{
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 8px;
      border: 1px solid rgba(246,183,60,.35);
      background: rgba(246,183,60,.12);
      color: #7a4d00;
      font-weight: 800;
    }

    .day{
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.82);
      box-shadow: 0 8px 22px rgba(20,21,26,.06);
      margin-bottom: 12px;
    }
    .dayHeader{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .dayTitle{ font-weight: 900; letter-spacing:-.2px; }
    .dayMeta{
      font-size: 12px;
      color: var(--muted);
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:4px;
    }
    .items{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border: 1px solid rgba(20,21,26,.12);
      border-radius: 16px;
      padding: 10px 10px;
      background: white;
      display:grid;
      grid-template-columns: 74px 1fr auto;
      gap: 10px;
      align-items:start;
    }
    .item.dragging{
      opacity:.65;
      transform: rotate(-.4deg);
      border-color: rgba(109,92,255,.55);
      box-shadow: 0 12px 28px rgba(109,92,255,.16);
    }
    .time{
      font-weight: 800;
      font-size: 12px;
      color: var(--chipText);
      background: rgba(109,92,255,.10);
      border: 1px solid rgba(109,92,255,.22);
      border-radius: 12px;
      padding: 8px 8px;
      text-align:center;
    }
    .cat{
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(20,21,26,.12);
      color: var(--muted);
      background: rgba(246,247,251,.8);
    }
    .pillRef{
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 8px;
      border: 1px solid rgba(109,92,255,.28);
      background: rgba(109,92,255,.10);
      color: #2c2f64;
      font-weight: 800;
    }
    .itemRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }
    .mutedSmall{ font-size:11px; color: var(--muted); }

    @media print{
      header, .panel{ display:none !important; }
      main{ grid-template-columns: 1fr; }
      body{ background:white; }
      .day,.card{ break-inside: avoid; box-shadow:none; }
      .item,.opt{ break-inside: avoid; }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo"></div>
    <div>
      <h1>Trip Planner ‚Äî Options + Itinerary</h1>
      <div class="sub">Keep multiple hotel/restaurant/activity options per destination, then build a flexible day-by-day plan.</div>
    </div>
  </div>
  <div class="toolbar">
    <button id="btnPrint" title="Print (or Save as PDF)">Print</button>
    <button id="btnExport" title="Export to JSON">Export</button>
    <button id="btnImport" title="Import JSON">Import</button>
    <button class="danger" id="btnReset" title="Reset everything">Reset</button>
    <button class="primary" id="btnAddDay">+ Add Day</button>
    <button class="primary" id="btnAddDest">+ Add Destination</button>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Controls</h2>

    <label>Trip name</label>
    <input id="tripName" placeholder="e.g., Italy 2026 ‚Äî Rome, Tuscany, Venice, Sardinia" />

    <div class="hr"></div>

    <div class="tabs" role="tablist">
      <div class="tab active" id="tabOpt" role="tab" aria-selected="true">Add Option</div>
      <div class="tab" id="tabItin" role="tab" aria-selected="false">Add Itinerary Item</div>
    </div>

    <!-- OPTIONS FORM -->
    <div id="optForm">
      <label>Destination</label>
      <select id="destSelect"></select>

      <div class="row">
        <div>
          <label>Option type</label>
          <select id="optType">
            <option value="hotels">Hotel</option>
            <option value="restaurants">Restaurant</option>
            <option value="activities">Activity</option>
          </select>
        </div>
        <div>
          <label>Mark as</label>
          <select id="optPick">
            <option value="alt">Alternative</option>
            <option value="selected">Selected</option>
          </select>
        </div>
      </div>

      <label>Name</label>
      <input id="optName" placeholder="e.g., Hotel Santa Maria / Da Enzo / Vatican Museums early entry" />

      <div class="row">
        <div>
          <label>Neighborhood / area (optional)</label>
          <input id="optArea" placeholder="e.g., Trastevere / San Marco / Greve in Chianti" />
        </div>
        <div>
          <label>Estimated cost (optional)</label>
          <input id="optCost" inputmode="decimal" placeholder="e.g., 220" />
        </div>
      </div>

      <label>Link (optional)</label>
      <input id="optLink" placeholder="Paste URL (hotel page, maps, reservation, etc.)" />

      <label>Notes</label>
      <textarea id="optNotes" placeholder="Pros/cons, vibe, cancellation policy, must-order dish, opening hours, etc."></textarea>

      <div class="row">
        <div>
          <label>&nbsp;</label>
          <button class="primary" id="btnAddOption" style="width:100%">Add option</button>
        </div>
      </div>

      <div class="help">
        Use this to keep <b>multiple options</b> per destination without committing to one.
        Later, you can mark one as <b>Selected</b> and keep the rest as alternatives.
      </div>
    </div>

    <!-- ITINERARY FORM -->
    <div id="itinForm" class="hidden">
      <label>Add to day</label>
      <select id="daySelect"></select>

      <label>Destination (optional, but recommended)</label>
      <select id="itinDestSelect"></select>

      <div class="row">
        <div>
          <label>Time</label>
          <input id="time" placeholder="e.g., 9:00 AM" />
        </div>
        <div>
          <label>Category</label>
          <select id="category">
            <option>Hotel</option>
            <option>Restaurant</option>
            <option>Activity</option>
            <option>Transport</option>
            <option>Cafe / Gelato</option>
            <option>Museum / Sight</option>
            <option>Shopping</option>
            <option>Day Trip</option>
            <option>Note</option>
          </select>
        </div>
      </div>

      <label>Item name (or select an option below)</label>
      <input id="name" placeholder="e.g., Dinner in Trastevere / Train to Venice / Beach day" />

      <label>Link to an option (optional)</label>
      <select id="optionRef">
        <option value="">‚Äî No linked option ‚Äî</option>
      </select>

      <div class="row">
        <div>
          <label>Estimated cost (optional)</label>
          <input id="cost" inputmode="decimal" placeholder="e.g., 35" />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option value="planned">Planned</option>
            <option value="booked">Booked</option>
          </select>
        </div>
      </div>

      <label>Notes</label>
      <textarea id="notes" placeholder="Reservation details, address, walking time, etc."></textarea>

      <div class="row">
        <div>
          <label>&nbsp;</label>
          <button class="primary" id="btnAddItem" style="width:100%">Add itinerary item</button>
        </div>
      </div>

      <div class="help">
        The key: itinerary items can be vague (<i>‚ÄúDinner somewhere good‚Äù</i>) or can link to a specific saved option.
      </div>
    </div>

    <div class="hr"></div>
    <div class="mutedSmall" id="saveHint">Autosave: on</div>
    <input id="fileImport" type="file" accept="application/json" class="hidden" />
  </section>

  <section>
    <div class="card">
      <div class="destHeader" id="destHeaderTitle" style="cursor:default">
        <div>
          <div class="destTitle">Destination Options</div>
          <div class="destMeta">
            <span class="badge">Hotels ‚Ä¢ Restaurants ‚Ä¢ Activities</span>
            <span class="badge">Mark ‚ÄúSelected‚Äù when you decide</span>
          </div>
        </div>
      </div>
      <div id="destinations"></div>
    </div>

    <div class="card">
      <div class="destHeader" style="cursor:default">
        <div>
          <div class="destTitle">Day-by-Day Itinerary</div>
          <div class="destMeta">
            <span class="badge">Drag to reorder within a day</span>
            <span class="badge">Items can stay flexible</span>
          </div>
        </div>
      </div>
      <div id="days"></div>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const STORAGE_KEY = "tripPlanner_options_v1";
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const defaultState = () => ({
    tripName: "My Trip",
    destinations: [
      { id: uid(), name: "Destination 1", collapsed: false,
        hotels: [], restaurants: [], activities: []
      }
    ],
    days: [
      { id: uid(), title: "Day 1", date:"", destId:"", collapsed:false, items: [] }
    ]
  });

  let state = load() ?? defaultState();

  // Tabs
  const tabOpt = $("tabOpt");
  const tabItin = $("tabItin");
  const optForm = $("optForm");
  const itinForm = $("itinForm");

  function setTab(which){
    const opt = which === "opt";
    tabOpt.classList.toggle("active", opt);
    tabItin.classList.toggle("active", !opt);
    tabOpt.setAttribute("aria-selected", opt ? "true":"false");
    tabItin.setAttribute("aria-selected", !opt ? "true":"false");
    optForm.classList.toggle("hidden", !opt);
    itinForm.classList.toggle("hidden", opt);
  }
  tabOpt.addEventListener("click", () => setTab("opt"));
  tabItin.addEventListener("click", () => setTab("itin"));

  // Elements
  const tripNameEl = $("tripName");
  const destSelectEl = $("destSelect");
  const optTypeEl = $("optType");
  const optPickEl = $("optPick");
  const optNameEl = $("optName");
  const optAreaEl = $("optArea");
  const optCostEl = $("optCost");
  const optLinkEl = $("optLink");
  const optNotesEl = $("optNotes");

  const daySelectEl = $("daySelect");
  const itinDestSelectEl = $("itinDestSelect");
  const optionRefEl = $("optionRef");
  const timeEl = $("time");
  const categoryEl = $("category");
  const nameEl = $("name");
  const costEl = $("cost");
  const statusEl = $("status");
  const notesEl = $("notes");

  const destinationsWrap = $("destinations");
  const daysWrap = $("days");

  tripNameEl.value = state.tripName || "My Trip";
  renderAll();

  tripNameEl.addEventListener("input", () => {
    state.tripName = tripNameEl.value.trim() || "My Trip";
    save();
  });

  $("btnAddDest").addEventListener("click", () => {
    const n = state.destinations.length + 1;
    state.destinations.push({ id: uid(), name: `Destination ${n}`, collapsed:false, hotels:[], restaurants:[], activities:[] });
    save(); renderAll();
  });

  $("btnAddDay").addEventListener("click", () => {
    const n = state.days.length + 1;
    state.days.push({ id: uid(), title:`Day ${n}`, date:"", destId:"", collapsed:false, items:[] });
    save(); renderAll();
  });

  $("btnReset").addEventListener("click", () => {
    const ok = confirm("Reset everything? This will erase your saved trip in this browser.");
    if (!ok) return;
    state = defaultState();
    save(); renderAll();
  });

  $("btnPrint").addEventListener("click", () => window.print());

  $("btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${(state.tripName || "trip").replace(/[^\w\-]+/g, "_").slice(0,50)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 3000);
  });

  $("btnImport").addEventListener("click", () => $("fileImport").click());
  $("fileImport").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data || !Array.isArray(data.days) || !Array.isArray(data.destinations)) throw new Error("Not a valid file.");
      state = normalize(data);
      save(); renderAll();
      alert("Imported successfully!");
    }catch(err){
      alert("Import failed: " + (err?.message || err));
    }finally{
      e.target.value = "";
    }
  });

  $("btnAddOption").addEventListener("click", () => {
    const destId = destSelectEl.value;
    const d = state.destinations.find(x => x.id === destId);
    if (!d) return;

    const nm = optNameEl.value.trim();
    if (!nm){ optNameEl.focus(); flash(optNameEl); return; }

    const listKey = optTypeEl.value; // hotels/restaurants/activities
    d[listKey].push({
      id: uid(),
      name: nm,
      area: optAreaEl.value.trim(),
      link: optLinkEl.value.trim(),
      notes: optNotesEl.value.trim(),
      cost: parseCost(optCostEl.value),
      selected: (optPickEl.value === "selected")
    });

    // clear
    optNameEl.value = "";
    optAreaEl.value = "";
    optLinkEl.value = "";
    optNotesEl.value = "";
    optCostEl.value = "";
    optPickEl.value = "alt";

    // if selected, unselect others in same list
    if (d[listKey].at(-1).selected){
      d[listKey].forEach(o => { if (o.id !== d[listKey].at(-1).id) o.selected = false; });
    }

    save(); renderAll();
  });

  $("btnAddItem").addEventListener("click", () => {
    const dayId = daySelectEl.value;
    const day = state.days.find(d => d.id === dayId);
    if (!day) return;

    const title = nameEl.value.trim();
    if (!title){ nameEl.focus(); flash(nameEl); return; }

    const ref = optionRefEl.value || "";
    day.destId = itinDestSelectEl.value || day.destId || "";

    day.items.push({
      id: uid(),
      time: timeEl.value.trim(),
      category: categoryEl.value,
      name: title,
      refOptionId: ref, // optional
      cost: parseCost(costEl.value),
      status: statusEl.value,
      notes: notesEl.value.trim()
    });

    timeEl.value=""; nameEl.value=""; costEl.value=""; notesEl.value=""; optionRefEl.value=""; statusEl.value="planned";

    save(); renderAll();
  });

  function parseCost(v){
    const s = (v || "").toString().trim();
    if (!s) return null;
    const cleaned = s.replace(/[^0-9.\-]/g, "");
    if (!cleaned) return null;
    const num = Number(cleaned);
    return Number.isFinite(num) ? num : null;
  }

  function save(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      $("saveHint").textContent = "Autosave: on";
    }catch(e){
      $("saveHint").textContent = "Autosave: failed (storage blocked)";
    }
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return normalize(JSON.parse(raw));
    }catch(e){ return null; }
  }

  function normalize(data){
    const out = {
      tripName: (data.tripName || "My Trip").toString(),
      destinations: Array.isArray(data.destinations) ? data.destinations.map(d => ({
        id: d.id || uid(),
        name: (d.name || "Destination").toString(),
        collapsed: !!d.collapsed,
        hotels: normalizeOpts(d.hotels),
        restaurants: normalizeOpts(d.restaurants),
        activities: normalizeOpts(d.activities)
      })) : [],
      days: Array.isArray(data.days) ? data.days.map(d => ({
        id: d.id || uid(),
        title: (d.title || "Day").toString(),
        date: (d.date || "").toString(),
        destId: (d.destId || "").toString(),
        collapsed: !!d.collapsed,
        items: Array.isArray(d.items) ? d.items.map(it => ({
          id: it.id || uid(),
          time: (it.time || "").toString(),
          category: (it.category || "Note").toString(),
          name: (it.name || "Untitled").toString(),
          refOptionId: (it.refOptionId || "").toString(),
          cost: (it.cost === null || it.cost === undefined) ? null : Number(it.cost),
          status: (it.status === "booked") ? "booked" : "planned",
          notes: (it.notes || "").toString()
        })) : []
      })) : []
    };
    if (!out.destinations.length) out.destinations = defaultState().destinations;
    if (!out.days.length) out.days = defaultState().days;
    return out;

    function normalizeOpts(arr){
      return Array.isArray(arr) ? arr.map(o => ({
        id: o.id || uid(),
        name: (o.name || "Option").toString(),
        area: (o.area || "").toString(),
        link: (o.link || "").toString(),
        notes: (o.notes || "").toString(),
        cost: (o.cost === null || o.cost === undefined) ? null : Number(o.cost),
        selected: !!o.selected
      })) : [];
    }
  }

  function renderAll(){
    renderDestSelects();
    renderOptionRef();
    renderDestinations();
    renderDays();
    document.title = `${state.tripName || "Trip"} ‚Äî Trip Planner`;
  }

  function renderDestSelects(){
    // Destination dropdowns
    destSelectEl.innerHTML = "";
    itinDestSelectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî No destination ‚Äî";
    itinDestSelectEl.appendChild(opt0);

    state.destinations.forEach((d) => {
      const o1 = document.createElement("option");
      o1.value = d.id; o1.textContent = d.name;
      destSelectEl.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = d.id; o2.textContent = d.name;
      itinDestSelectEl.appendChild(o2);
    });

    // Days dropdown
    daySelectEl.innerHTML = "";
    state.days.forEach((d, idx) => {
      const opt = document.createElement("option");
      opt.value = d.id;
      const destName = getDestName(d.destId);
      opt.textContent = [d.title || `Day ${idx+1}`, d.date ? `(${d.date})` : "", destName ? `‚Äî ${destName}` : ""].filter(Boolean).join(" ");
      daySelectEl.appendChild(opt);
    });
  }

  // Build option reference list (so itinerary items can link to any option)
  function renderOptionRef(){
    optionRefEl.innerHTML = `<option value="">‚Äî No linked option ‚Äî</option>`;
    const destId = itinDestSelectEl.value || ""; // show relevant options if picked
    const pools = getAllOptions(destId);

    pools.forEach(({ id, label }) => {
      const o = document.createElement("option");
      o.value = id;
      o.textContent = label;
      optionRefEl.appendChild(o);
    });
  }

  itinDestSelectEl.addEventListener("change", () => {
    renderOptionRef();
  });

  function renderDestinations(){
    destinationsWrap.innerHTML = "";

    state.destinations.forEach((d) => {
      const card = document.createElement("div");
      card.className = "card";
      card.style.marginBottom = "14px";

      const header = document.createElement("div");
      header.className = "destHeader";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "destTitle";
      title.textContent = d.name;

      const meta = document.createElement("div");
      meta.className = "destMeta";
      meta.innerHTML = `
        <span class="badge">${d.hotels.length} hotel option${d.hotels.length===1?"":"s"}</span>
        <span class="badge">${d.restaurants.length} restaurant option${d.restaurants.length===1?"":"s"}</span>
        <span class="badge">${d.activities.length} activity option${d.activities.length===1?"":"s"}</span>
      `;

      left.appendChild(title);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "destActions";
      actions.appendChild(mkBtn("Edit", "small", () => editDest(d.id)));
      actions.appendChild(mkBtn(d.collapsed ? "Expand" : "Collapse", "small", () => toggleDest(d.id)));
      actions.appendChild(mkBtn("Delete", "small danger", () => deleteDest(d.id)));

      header.appendChild(left);
      header.appendChild(actions);

      const body = document.createElement("div");
      body.classList.toggle("hidden", d.collapsed);

      body.appendChild(renderPool(d, "Hotels", "hotels"));
      body.appendChild(renderPool(d, "Restaurants", "restaurants"));
      body.appendChild(renderPool(d, "Activities", "activities"));

      card.appendChild(header);
      card.appendChild(body);
      destinationsWrap.appendChild(card);
    });
  }

  function renderPool(dest, label, key){
    const wrap = document.createElement("div");

    const t = document.createElement("div");
    t.className = "sectionTitle";
    t.innerHTML = `<span><b>${label}</b></span><span class="badge">Selected: ${dest[key].some(o=>o.selected) ? "Yes" : "No"}</span>`;
    wrap.appendChild(t);

    const list = document.createElement("div");
    list.className = "list";

    if (!dest[key].length){
      const empty = document.createElement("div");
      empty.className = "mutedSmall";
      empty.textContent = "No options yet ‚Äî add some from the left panel.";
      list.appendChild(empty);
    }

    dest[key].forEach(opt => {
      const el = document.createElement("div");
      el.className = "opt";

      const left = document.createElement("div");
      const pill = opt.selected ? `<span class="pillSel">Selected</span>` : `<span class="pillAlt">Alternative</span>`;
      const costTxt = Number.isFinite(opt.cost) ? money(opt.cost) : "";
      left.innerHTML = `
        <div class="optTop">
          <span class="name">${escapeHtml(opt.name)}</span>
          ${pill}
        </div>
        <div class="mini">
          ${opt.area ? `<span>üìç ${escapeHtml(opt.area)}</span>` : ""}
          ${costTxt ? `<span>üíµ ${escapeHtml(costTxt)}</span>` : ""}
          ${opt.link ? `<span>üîó <a class="link" href="${escapeAttr(opt.link)}" target="_blank" rel="noopener">Link</a></span>` : ""}
        </div>
        ${opt.notes ? `<div class="notes">${escapeHtml(opt.notes)}</div>` : ""}
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.flexWrap = "wrap";
      right.style.justifyContent = "flex-end";

      right.appendChild(mkBtn(opt.selected ? "Unselect" : "Select", "small good", () => setSelected(dest.id, key, opt.id, !opt.selected)));
      right.appendChild(mkBtn("Copy", "small", () => copyOption(dest.id, key, opt.id)));
      right.appendChild(mkBtn("Edit", "small", () => editOption(dest.id, key, opt.id)));
      right.appendChild(mkBtn("Delete", "small danger", () => deleteOption(dest.id, key, opt.id)));

      el.appendChild(left);
      el.appendChild(right);
      list.appendChild(el);
    });

    wrap.appendChild(list);
    wrap.appendChild(document.createElement("div")).className="hr";
    return wrap;
  }

  function renderDays(){
    daysWrap.innerHTML = "";

    state.days.forEach((day, dayIndex) => {
      const dayEl = document.createElement("div");
      dayEl.className = "day";
      dayEl.dataset.dayId = day.id;

      const header = document.createElement("div");
      header.className = "dayHeader";

      const left = document.createElement("div");

      const title = document.createElement("div");
      title.className = "dayTitle";
      title.textContent = day.title || `Day ${dayIndex+1}`;

      const meta = document.createElement("div");
      meta.className = "dayMeta";
      meta.innerHTML = `
        <span class="badge">${day.date ? escapeHtml(day.date) : "No date"}</span>
        <span class="badge">${getDestName(day.destId) || "No destination"}</span>
        <span class="badge">${day.items.length} item${day.items.length===1?"":"s"}</span>
        <span class="badge">Drag to reorder</span>
      `;

      left.appendChild(title);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "destActions";
      actions.appendChild(mkBtn("Edit day", "small", () => editDay(day.id)));
      actions.appendChild(mkBtn("Duplicate", "small", () => duplicateDay(day.id)));
      actions.appendChild(mkBtn("Delete", "small danger", () => deleteDay(day.id)));

      header.appendChild(left);
      header.appendChild(actions);

      header.addEventListener("click", (e) => {
        if (e.target.closest("button")) return;
        day.collapsed = !day.collapsed;
        save(); renderDays();
      });

      const itemsWrap = document.createElement("div");
      itemsWrap.className = "items";
      if (day.collapsed) itemsWrap.classList.add("hidden");

      itemsWrap.addEventListener("dragover", (e) => {
        e.preventDefault();
        const dragging = itemsWrap.querySelector(".dragging");
        if (!dragging) return;
        const after = getDragAfterElement(itemsWrap, e.clientY);
        if (after == null) itemsWrap.appendChild(dragging);
        else itemsWrap.insertBefore(dragging, after);
      });

      itemsWrap.addEventListener("drop", (e) => {
        e.preventDefault();
        const ids = [...itemsWrap.querySelectorAll(".item")].map(el => el.dataset.itemId);
        day.items.sort((a,b) => ids.indexOf(a.id) - ids.indexOf(b.id));
        save();
      });

      day.items.forEach((it) => {
        const itemEl = document.createElement("div");
        itemEl.className = "item";
        itemEl.draggable = true;
        itemEl.dataset.itemId = it.id;

        itemEl.addEventListener("dragstart", () => itemEl.classList.add("dragging"));
        itemEl.addEventListener("dragend", () => itemEl.classList.remove("dragging"));

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = it.time || "‚Äî";

        const main = document.createElement("div");
        const refLabel = it.refOptionId ? getOptionLabel(it.refOptionId) : "";
        const refPill = refLabel ? `<span class="pillRef">Option: ${escapeHtml(refLabel)}</span>` : "";
        const costTxt = Number.isFinite(it.cost) ? money(it.cost) : "";
        const statusPill = it.status === "booked"
          ? `<span class="pillSel">Booked</span>`
          : `<span class="pillAlt">Planned</span>`;

        main.innerHTML = `
          <div class="optTop">
            <span class="cat">${escapeHtml(it.category || "Note")}</span>
            <span class="name">${escapeHtml(it.name || "Untitled")}</span>
            ${statusPill}
            ${refPill}
          </div>
          <div class="mini">
            ${costTxt ? `<span>üíµ ${escapeHtml(costTxt)}</span>` : ""}
            ${it.notes ? `<span>üìù ${escapeHtml(it.notes)}</span>` : ""}
          </div>
        `;

        const right = document.createElement("div");
        right.className = "itemRight";

        const btns = document.createElement("div");
        btns.style.display = "flex";
        btns.style.gap = "8px";
        btns.style.flexWrap = "wrap";
        btns.style.justifyContent = "flex-end";

        btns.appendChild(mkBtn(it.status === "booked" ? "Unbook" : "Book", "small good", () => toggleBooked(day.id, it.id)));
        btns.appendChild(mkBtn("Copy", "small", () => copyItem(day.id, it.id)));
        btns.appendChild(mkBtn("Edit", "small", () => editItem(day.id, it.id)));
        btns.appendChild(mkBtn("Delete", "small danger", () => deleteItem(day.id, it.id)));

        right.appendChild(btns);

        itemEl.appendChild(time);
        itemEl.appendChild(main);
        itemEl.appendChild(right);

        itemsWrap.appendChild(itemEl);
      });

      dayEl.appendChild(header);
      dayEl.appendChild(itemsWrap);
      daysWrap.appendChild(dayEl);
    });
  }

  // ---- Actions: destinations/options ----
  function editDest(destId){
    const d = state.destinations.find(x => x.id === destId);
    if (!d) return;
    const name = prompt("Destination name (e.g., Rome (Trastevere) / Venice / Sardinia):", d.name);
    if (name === null) return;
    d.name = name.trim() || d.name;
    save(); renderAll();
  }

  function toggleDest(destId){
    const d = state.destinations.find(x => x.id === destId);
    if (!d) return;
    d.collapsed = !d.collapsed;
    save(); renderDestinations();
  }

  function deleteDest(destId){
    if (state.destinations.length === 1){
      alert("You need at least one destination.");
      return;
    }
    const ok = confirm("Delete this destination and all its options?");
    if (!ok) return;

    // Remove destination
    state.destinations = state.destinations.filter(d => d.id !== destId);

    // Remove references in days/items
    state.days.forEach(day => {
      if (day.destId === destId) day.destId = "";
      day.items.forEach(it => {
        if (it.refOptionId && !findOption(it.refOptionId)) it.refOptionId = "";
      });
    });

    save(); renderAll();
  }

  function setSelected(destId, key, optId, selected){
    const d = state.destinations.find(x => x.id === destId);
    if (!d) return;
    const opt = d[key].find(o => o.id === optId);
    if (!opt) return;
    opt.selected = !!selected;
    if (opt.selected){
      d[key].forEach(o => { if (o.id !== optId) o.selected = false; });
    }
    save(); renderAll();
  }

  function copyOption(destId, key, optId){
    const d = state.destinations.find(x => x.id === destId);
    const opt = d?.[key]?.find(o => o.id === optId);
    if (!opt) return;
    d[key].push({ ...opt, id: uid(), selected:false });
    save(); renderAll();
  }

  function editOption(destId, key, optId){
    const d = state.destinations.find(x => x.id === destId);
    const opt = d?.[key]?.find(o => o.id === optId);
    if (!opt) return;

    const nm = prompt("Option name:", opt.name);
    if (nm === null) return;
    const area = prompt("Neighborhood/area (optional):", opt.area || "");
    if (area === null) return;
    const link = prompt("Link (optional):", opt.link || "");
    if (link === null) return;
    const cost = prompt("Estimated cost (optional):", (Number.isFinite(opt.cost) ? String(opt.cost) : ""));
    if (cost === null) return;
    const notes = prompt("Notes (optional):", opt.notes || "");
    if (notes === null) return;

    opt.name = nm.trim() || opt.name;
    opt.area = (area || "").trim();
    opt.link = (link || "").trim();
    opt.cost = parseCost(cost);
    opt.notes = (notes || "").trim();

    save(); renderAll();
  }

  function deleteOption(destId, key, optId){
    const d = state.destinations.find(x => x.id === destId);
    if (!d) return;
    d[key] = d[key].filter(o => o.id !== optId);

    // Remove itinerary references to this option
    state.days.forEach(day => {
      day.items.forEach(it => {
        if (it.refOptionId === optId) it.refOptionId = "";
      });
    });

    save(); renderAll();
  }

  // ---- Actions: days/items ----
  function editDay(dayId){
    const d = state.days.find(x => x.id === dayId);
    if (!d) return;

    const title = prompt("Day title (e.g., Day 3 ‚Äî Venice):", d.title || "");
    if (title === null) return;

    const date = prompt("Date (optional, e.g., May 12):", d.date || "");
    if (date === null) return;

    const destName = prompt("Destination for this day (type destination name exactly, or leave blank):", getDestName(d.destId) || "");
    if (destName === null) return;

    const destId = (destName.trim() ? findDestIdByName(destName.trim()) : "");
    if (destName.trim() && !destId){
      alert("Couldn't find that destination name. (Tip: copy/paste the destination name from above.)");
    }

    d.title = title.trim() || d.title;
    d.date = date.trim();
    d.destId = destId || "";

    save(); renderAll();
  }

  function duplicateDay(dayId){
    const d = state.days.find(x => x.id === dayId);
    if (!d) return;
    const copy = {
      id: uid(),
      title: (d.title ? d.title + " (copy)" : "Day (copy)"),
      date: d.date,
      destId: d.destId,
      collapsed: d.collapsed,
      items: d.items.map(it => ({...it, id: uid()}))
    };
    state.days.splice(state.days.findIndex(x => x.id === dayId) + 1, 0, copy);
    save(); renderAll();
  }

  function deleteDay(dayId){
    if (state.days.length === 1){
      alert("You need at least one day.");
      return;
    }
    const ok = confirm("Delete this day and all its items?");
    if (!ok) return;
    state.days = state.days.filter(d => d.id !== dayId);
    save(); renderAll();
  }

  function toggleBooked(dayId, itemId){
    const d = state.days.find(x => x.id === dayId);
    const it = d?.items.find(x => x.id === itemId);
    if (!it) return;
    it.status = (it.status === "booked") ? "planned" : "booked";
    save(); renderAll();
  }

  function copyItem(dayId, itemId){
    const d = state.days.find(x => x.id === dayId);
    const it = d?.items.find(x => x.id === itemId);
    if (!it) return;
    d.items.push({ ...it, id: uid(), status: "planned" });
    save(); renderAll();
  }

  function editItem(dayId, itemId){
    const d = state.days.find(x => x.id === dayId);
    const it = d?.items.find(x => x.id === itemId);
    if (!it) return;

    daySelectEl.value = dayId;
    itinDestSelectEl.value = d.destId || "";
    renderOptionRef();

    timeEl.value = it.time || "";
    categoryEl.value = it.category || "Note";
    nameEl.value = it.name || "";
    costEl.value = (Number.isFinite(it.cost) ? String(it.cost) : "");
    statusEl.value = it.status || "planned";
    notesEl.value = it.notes || "";
    optionRefEl.value = it.refOptionId || "";

    setTab("itin");

    const ok = confirm("Loaded into form. Click OK to delete the old item now, then click ‚ÄúAdd itinerary item‚Äù to re-add the edited version.");
    if (!ok) return;

    d.items = d.items.filter(x => x.id !== itemId);
    save(); renderAll();
  }

  function deleteItem(dayId, itemId){
    const d = state.days.find(x => x.id === dayId);
    if (!d) return;
    d.items = d.items.filter(it => it.id !== itemId);
    save(); renderAll();
  }

  // ---- Helpers ----
  function mkBtn(text, cls, onClick){
    const b = document.createElement("button");
    b.textContent = text;
    b.className = (cls || "");
    b.classList.add("small");
    b.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      onClick();
    });
    return b;
  }

  function flash(el){
    el.style.transition = "box-shadow .15s ease";
    el.style.boxShadow = "0 0 0 4px rgba(255,77,109,.18)";
    setTimeout(()=> el.style.boxShadow = "", 380);
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return (str ?? "").toString().replaceAll('"',"&quot;");
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll(".item:not(.dragging)")];
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    for (const child of els){
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset < 0 && offset > closest.offset){
        closest = { offset, element: child };
      }
    }
    return closest.element;
  }

  function money(n){
    if (!Number.isFinite(n)) return "$0";
    return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
  }

  function getDestName(destId){
    if (!destId) return "";
    return state.destinations.find(d => d.id === destId)?.name || "";
  }

  function findDestIdByName(name){
    const lower = name.toLowerCase();
    return state.destinations.find(d => (d.name || "").toLowerCase() === lower)?.id || "";
  }

  function findOption(optId){
    for (const d of state.destinations){
      for (const key of ["hotels","restaurants","activities"]){
        const found = d[key].find(o => o.id === optId);
        if (found) return { dest: d, key, opt: found };
      }
    }
    return null;
  }

  function getOptionLabel(optId){
    const found = findOption(optId);
    if (!found) return "";
    const typeLabel = found.key === "hotels" ? "Hotel" : found.key === "restaurants" ? "Restaurant" : "Activity";
    return `${typeLabel}: ${found.opt.name} (${found.dest.name})`;
  }

  function getAllOptions(destId){
    const list = [];
    const dests = destId ? state.destinations.filter(d => d.id === destId) : state.destinations;

    dests.forEach(d => {
      [["hotels","Hotel"],["restaurants","Restaurant"],["activities","Activity"]].forEach(([key, type]) => {
        d[key].forEach(o => {
          const prefix = o.selected ? "‚òÖ " : "";
          list.push({ id: o.id, label: `${prefix}${type} ‚Äî ${o.name} (${d.name})` });
        });
      });
    });

    // Selected first
    list.sort((a,b) => (a.label.startsWith("‚òÖ") ? -1 : 0) - (b.label.startsWith("‚òÖ") ? -1 : 0));
    return list;
  }

  // keep optionRef updated if destinations change
  window.addEventListener("storage", (e) => {
    if (e.key === STORAGE_KEY){
      state = load() ?? defaultState();
      tripNameEl.value = state.tripName || "My Trip";
      renderAll();
    }
  });

})();
</script>
</body>
</html>
